'use strict';var g=require("outline"),n=require("outline/ListNode"),t=require("outline/ListItemNode"),x=require("outline/ParagraphNode"),z=require("outline/HeadingNode"),A=require("outline/LinkNode");function B(a){return a.isToken()||a.isInert()}
function C(a){a=a.getLatest();const b=a.constructor.clone(a);b.__parent=a.__parent;g.$isElementNode(a)&&g.$isElementNode(b)?(b.__children=Array.from(a.__children),b.__format=a.__format,b.__indent=a.__indent,b.__dir=a.__dir):g.$isTextNode(a)&&g.$isTextNode(b)?(b.__format=a.__format,b.__style=a.__style,b.__mode=a.__mode,b.__detail=a.__detail):g.$isDecoratorNode(a)&&g.$isDecoratorNode(b)&&(b.__ref=a.__ref);return b}
function D(a,b,c,d,f){for(var e=b;null!==a;){for(b=a.getParent();null!==b&&b.excludeFromCopy();)b=b.getParent();if(null===b)break;if(!g.$isElementNode(a)||!a.excludeFromCopy()){const h=a.getKey();let k=f.get(h);const l=void 0===k;l&&(k=C(a),f.set(h,k));!g.$isTextNode(k)||k.isSegmented()||k.isToken()?g.$isElementNode(k)&&(k.__children=k.__children.slice(c?e:0,c?void 0:e+1)):k.__text=k.__text.slice(c?e:0,c?void 0:e);if(g.$isRootNode(b)){l&&d.push(h);break}}e=f.get(b.getKey());e=g.$isElementNode(e)?
e.__children.indexOf(a.getKey()):a.getIndexWithinParent();a=b}}function E(a,b){const c=b.split(/\r?\n/);if(1===c.length)a.insertText(b);else{b=[];const d=c.length;for(let f=0;f<d;f++){const e=c[f];""!==e&&b.push(g.$createTextNode(e));f!==d-1&&b.push(g.$createLineBreakNode())}a.insertNodes(b)}}const F="undefined"!==typeof window&&"undefined"!==typeof window.document&&"undefined"!==typeof window.document.createElement,G=F&&"documentMode"in document?document.documentMode:null;F&&/Win/.test(navigator.platform);
F&&/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;const H=F&&/Mac|iPod|iPhone|iPad/.test(navigator.platform),I=F&&/^(?!.*Seamonkey)(?=.*Firefox).*/i.test(navigator.userAgent);F&&/Version\/[\d\.]+.*Safari/.test(navigator.userAgent);F&&/^(?=.*Chrome).*/i.test(navigator.userAgent);F&&"InputEvent"in window&&!G?"getTargetRanges"in new window.InputEvent("input"):!1;const J={bold:1,underline:8,strikethrough:4,italic:2,code:16,subscript:32,superscript:64};let K=!1;
const L={ul:()=>({node:n.$createListNode("ul")}),ol:()=>({node:n.$createListNode("ol")}),li:()=>({node:t.$createListItemNode()}),h1:()=>({node:z.$createHeadingNode("h1")}),h2:()=>({node:z.$createHeadingNode("h2")}),h3:()=>({node:z.$createHeadingNode("h3")}),h4:()=>({node:z.$createHeadingNode("h4")}),h5:()=>({node:z.$createHeadingNode("h5")}),p:()=>({node:x.$createParagraphNode()}),br:()=>({node:g.$createLineBreakNode()}),a:a=>({node:a instanceof HTMLAnchorElement?A.$createLinkNode(a.href):g.$createTextNode(a.textContent)}),
u:()=>({node:null,format:"underline"}),b:()=>({node:null,format:"bold"}),strong:()=>({node:null,format:"bold"}),i:()=>({node:null,format:"italic"}),em:()=>({node:null,format:"italic"}),"#text":a=>({node:g.$createTextNode(a.textContent)})};
function M(a,b,c,d){let f=[],e=null;var h=a.nodeName.toLowerCase();h=(h=(c._config.htmlTransforms||{})[h]||b[h])?h(a):null;null!==h&&(e=h.node,h.format&&(h=J[h.format],d=d?d^h:h),null!==e&&(g.$isTextNode(e)&&void 0!==d&&e.setFormat(d),f.push(e)));a=a.childNodes;for(h=0;h<a.length;h++){const k=M(a[h],b,c,d);g.$isElementNode(e)?e.append(...k):null===e&&(f=f.concat(k))}return f}
function N(a,b,c){var d=a.getData("application/x-outline-nodes");if(d)try{var f=JSON.parse(d);const {range:l,nodeMap:m}=f;var e=new Map(m);d=[];for(f=0;f<l.length;f++){var h=e.get(l[f]);if(void 0!==h){var k=g.$createNodeFromParse(h,e);d.push(k)}}b.insertNodes(d);return}catch(l){}if(e=a.getData("text/html")){e=(new DOMParser).parseFromString(e,"text/html");a=[];e=e.body?Array.from(e.body.childNodes):[];h=e.length;for(k=0;k<h;k++)d=M(e[k],L,c),null!==d&&(a=a.concat(d));c=a;a=[];e=null;for(h=0;h<c.length;h++)k=
c[h],!g.$isElementNode(k)||k.isInline()?(null===e&&(e=x.$createParagraphNode(),a.push(e)),null!==e&&e.append(k)):(a.push(k),e=null);b.insertNodes(a)}else O(a,b)}function O(a,b){a=a.getData("text/plain");null!=a&&E(b,a)}
function P(a,b){a.preventDefault();b.update(()=>{g.$log("onCopyForPlainText");const c=a.clipboardData,d=g.$getSelection();if(null!==d&&null!=c){var f=window.getSelection();if(!f.isCollapsed){var e=f.getRangeAt(0);e&&(f=document.createElement("div"),e=e.cloneContents(),f.appendChild(e),c.setData("text/html",f.innerHTML));c.setData("text/plain",d.getTextContent())}}})}
function Q(a,b){a.preventDefault();b.update(()=>{g.$log("onCopyForRichText");const c=a.clipboardData;var d=g.$getSelection();if(null!==d&&null!=c){var f=window.getSelection();if(!f.isCollapsed){var e=f.getRangeAt(0);e&&(f=document.createElement("div"),e=e.cloneContents(),f.appendChild(e),c.setData("text/html",f.innerHTML));c.setData("text/plain",d.getTextContent());f=c.setData;e=JSON;var h=e.stringify;{var k=d.anchor,l=d.focus;var m=k.getCharacterOffset();const y=l.getCharacterOffset();var p=k.getNode(),
u=l.getNode(),q=p.getParentOrThrow();if(p===u&&g.$isTextNode(p)&&(q.canBeEmpty()||1<q.getChildrenSize()))d=C(p),p=y>m,d.__text=d.__text.slice(p?m:y,p?y:m),m=d.getKey(),m={range:[m],nodeMap:[[m,d]]};else if(d=d.getNodes(),0===d.length)m={range:[],nodeMap:[]};else{p=d.length;u=d[0];q=u.getParent();if(null!==q&&!q.canBeEmpty()){var v=q.__children;if(v.length===p){var r=!0;for(var w=0;w<v.length;w++)if(v[w]!==d[w].__key){r=!1;break}r&&(p++,d.push(q))}}q=d[p-1];k=k.isBefore(l);l=new Map;v=[];D(u,k?m:y,
!0,v,l);for(u=0;u<p;u++)if(r=d[u],w=r.getKey(),!(l.has(w)||g.$isElementNode(r)&&r.excludeFromCopy())){const V=C(r);g.$isRootNode(r.getParent())&&v.push(r.getKey());l.set(w,V)}D(q,k?y:m,!1,v,l);m={range:v,nodeMap:Array.from(l.entries())}}}f.call(c,"application/x-outline-nodes",h.call(e,m))}}})}function R(a,b){b.update(()=>{g.$log("onCompositionEnd");g.$setCompositionKey(null);S(b,!0)})}function T(a){return a.getEditorState().read(()=>g.$getSelection())}
function U(a,b,c,d,f){if(a.isAttached()&&(f||!a.isDirty())){const e=a.isComposing();let h=b;(e||f)&&"\u00a0"===b[b.length-1]&&(h=b.slice(0,-1));if(f||h!==a.getTextContent())""===h?(e&&g.$setCompositionKey(null),a.remove()):B(a)||null!==g.$getCompositionKey()&&!e?a.markDirty():(b=g.$getSelection(),null!==b&&null!==c&&null!==d&&(b.setTextNodeRange(a,c,a,d),a.isSegmented()&&(c=a.getTextContent(),c=g.$createTextNode(c),a.replace(c),a=c)),a.setTextContent(h))}}
function W(a,b,c){var d=a.anchor;const f=a.focus;var e=d.getNode();(b=d.key!==f.key||d.offset!==f.offset&&!e.isComposing()||(c||e.isDirty())&&1<b.length||!g.$isTextNode(e)||e.getFormat()!==a.format)||(e.isSegmented()?b=!0:a.isCollapsed()?(b=a.anchor.offset,c=e.getParentOrThrow(),d=e.isToken(),a=0===b&&(!e.canInsertTextBefore()||!c.canInsertTextBefore()||d),e=e.getTextContentSize()===b&&(!e.canInsertTextBefore()||!c.canInsertTextBefore()||d),b=a||e):b=!1);return b}
function S(a,b){a=window.getSelection();if(null!==a){var {anchorNode:c,anchorOffset:d,focusOffset:f}=a;null!==c&&3===c.nodeType&&(a=g.$getNearestNodeFromDOMNode(c),g.$isTextNode(a)&&U(a,c.nodeValue,d,f,b))}}exports.$createNodesFromDOM=M;exports.$onTextMutation=function(a){U(a.node,a.text,a.anchorOffset,a.focusOffset,!1)};
exports.$shouldOverrideDefaultCharacterSelection=function(a,b){var c=a.focus;a=c.offset;"element"===c.type?b=c.getNode().getChildAtIndex(b?a-1:a):(c=c.getNode(),b=b&&0===a||!b&&a===c.getTextContentSize()?b?c.getPreviousSibling():c.getNextSibling():null);return g.$isDecoratorNode(b)};exports.checkForBadInsertion=function(a,b,c){b=b.getNextSibling();return null===a.parentNode||null!==b&&c.getElementByKey(b.getKey())!==a.nextSibling};
exports.onBeforeInput=function(a,b){const c=a.inputType;"deleteCompositionText"!==c&&"insertCompositionText"!==c&&b.update(()=>{g.$log("onBeforeInputForRichText");const d=g.$getSelection();if(null!==d)if("deleteContentBackward"===c)g.$setCompositionKey(null),a.preventDefault(),b.execCommand("deleteCharacter",!0);else{var f=a.data;if(!d.dirty&&d.isCollapsed()&&a.getTargetRanges){var e=a.getTargetRanges()[0];e&&d.applyDOMRange(e)}var h=d.focus;e=d.anchor.getNode();h=h.getNode();if("insertText"===c)"\n"===
f?(a.preventDefault(),b.execCommand("insertLineBreak")):"\n\n"===f?(a.preventDefault(),b.execCommand("insertParagraph")):null==f&&a.dataTransfer?(f=a.dataTransfer.getData("text/plain"),a.preventDefault(),E(d,f)):null!=f&&W(d,f,!0)&&(a.preventDefault(),b.execCommand("insertText",f));else switch(a.preventDefault(),c){case "insertFromComposition":f&&(g.$setCompositionKey(null),b.execCommand("insertText",f));break;case "insertLineBreak":g.$setCompositionKey(null);b.execCommand("insertLineBreak");break;
case "insertParagraph":g.$setCompositionKey(null);b.execCommand("insertParagraph");break;case "insertFromYank":case "insertFromDrop":case "insertReplacementText":case "insertFromPaste":e=a.dataTransfer;null!=e?N(e,d,b):f&&b.execCommand("insertText",f);break;case "deleteByComposition":e===h&&!g.$isElementNode(e)&&!g.$isElementNode(h)&&B(e)&&B(h)||b.execCommand("removeText");break;case "deleteByDrag":case "deleteByCut":b.execCommand("removeText");break;case "deleteContent":b.execCommand("deleteCharacter",
!1);break;case "deleteWordBackward":b.execCommand("deleteWord",!0);break;case "deleteWordForward":b.execCommand("deleteWord",!1);break;case "deleteHardLineBackward":case "deleteSoftLineBackward":b.execCommand("deleteLine",!0);break;case "deleteContentForward":case "deleteHardLineForward":case "deleteSoftLineForward":b.execCommand("deleteLine",!1);break;case "formatStrikeThrough":b.execCommand("formatText","strikethrough");break;case "formatBold":b.execCommand("formatText","bold");break;case "formatItalic":b.execCommand("formatText",
"italic");break;case "formatUnderline":b.execCommand("formatText","underline");break;case "historyUndo":b.execCommand("undo");break;case "historyRedo":b.execCommand("redo")}}})};
exports.onClick=function(a,b){b.update(()=>{g.$log("onClick");const c=g.$getSelection();if(null!==c){var d=c.anchor;"element"===d.type&&0===d.offset&&c.isCollapsed()&&1===g.$getRoot().getChildrenSize()&&d.getNode().getTopLevelElementOrThrow().isEmpty()&&(d=T(b),null!==d&&c.is(d)&&(window.getSelection().removeAllRanges(),c.dirty=!0))}})};exports.onCompositionEnd=function(a,b){I?setTimeout(()=>{R(a,b)},0):R(a,b)};
exports.onCompositionStart=function(a,b){b.update(()=>{g.$log("onCompositionStart");const c=g.$getSelection();if(null!==c&&!b.isComposing()){const d=c.anchor;g.$setCompositionKey(d.key);null==a.data||K&&"element"!==d.type&&c.isCollapsed()||b.execCommand("insertText"," ")}})};exports.onCopyForPlainText=P;exports.onCopyForRichText=Q;exports.onCutForPlainText=function(a,b){P(a,b);b.update(()=>{g.$log("onCutForPlainText");const c=g.$getSelection();null!==c&&c.removeText()})};
exports.onCutForRichText=function(a,b){Q(a,b);b.update(()=>{g.$log("onCutForRichText");const c=g.$getSelection();null!==c&&c.removeText()})};exports.onDragStartPolyfill=function(a){a.preventDefault()};exports.onDropPolyfill=function(a){a.preventDefault()};exports.onInput=function(a,b){a.stopPropagation();b.update(()=>{g.$log("onInput");const c=g.$getSelection(),d=a.data;null!=d&&null!==c&&W(c,d,!1)?b.execCommand("insertText",d):S(b,!1);g.$flushMutations()})};
exports.onKeyDown=function(a,b){K="Unidentified"===a.key&&229===a.keyCode;b.isComposing()||b.update(()=>{g.$log("onKeyDown");if(null!==g.$getSelection()){var {keyCode:c,shiftKey:d,ctrlKey:f,metaKey:e,altKey:h}=a;if(39!==c||f||e||h)if(37!==c||f||e||h)if(38!==c||f||e||h)if(40!==c||f||e||h)if(13===a.keyCode&&a.shiftKey)b.execCommand("keyEnter",a);else if(H&&f&&79===c)a.preventDefault(),b.execCommand("insertLineBreak",!0);else if(13!==a.keyCode||a.shiftKey){var k=H?h||e?!1:8===c||72===c&&f:f||h||e?!1:
8===c;k?8===c?b.execCommand("keyBackspace",a):b.execCommand("deleteCharacter",!0):(k=H?d||h||e?!1:46===c||68===c&&f:f||h||e?!1:46===c,k?46===c?b.execCommand("keyDelete",a):b.execCommand("deleteCharacter",!1):8===c&&(H?h:f)?(a.preventDefault(),b.execCommand("deleteWord",!0)):46===c&&(H?h:f)?(a.preventDefault(),b.execCommand("deleteWord",!1)):H&&e&&8===c?(a.preventDefault(),b.execCommand("deleteLine",!0)):H&&e&&46===c?(a.preventDefault(),b.execCommand("deleteLine",!1)):66===c&&(H?e:f)?(a.preventDefault(),
b.execCommand("formatText","bold")):85===c&&(H?e:f)?(a.preventDefault(),b.execCommand("formatText","underline")):73===c&&(H?e:f)?(a.preventDefault(),b.execCommand("formatText","italic")):9!==c||h||f||e?90===c&&!d&&(H?e:f)?(a.preventDefault(),b.execCommand("undo")):(k=H?90===c&&e&&d:89===c&&f||90===c&&f&&d,k&&(a.preventDefault(),b.execCommand("redo"))):b.execCommand("keyTab",a))}else b.execCommand("keyEnter",a);else b.execCommand("keyArrowDown",a);else b.execCommand("keyArrowUp",a);else b.execCommand("keyArrowLeft",
a);else b.execCommand("keyArrowRight",a)}})};exports.onPasteForPlainText=function(a,b){a.preventDefault();b.update(()=>{g.$log("onPasteForPlainText");const c=g.$getSelection(),d=a.clipboardData;null!=d&&null!==c&&O(d,c)})};exports.onPasteForRichText=function(a,b){a.preventDefault();b.update(()=>{g.$log("onPasteForRichText");const c=g.$getSelection(),d=a.clipboardData;null!=d&&null!==c&&N(d,c,b)})};
exports.onSelectionChange=function(a,b){a=window.getSelection();const c=b.getRootElement();c&&!c.contains(a.anchorNode)||b.update(()=>{g.$log("onSelectionChange");const d=g.$getSelection();if(null!==d&&d.isCollapsed()){var f=d.anchor;"text"===f.type?(f=f.getNode(),d.format=f.getFormat()):"element"===f.type&&(d.format=0)}b.execCommand("selectionChange")})};
